import './app.css'

console.clear()
console.log('\n %c üéâBTCO %c https://github.com/LF112/BTCO %c BY%c LF112  \n\n', 'color: #ffffff; background: rgb(0, 145, 228); padding:5px 0;', 'background:rgba(197, 197, 197, 0.89); padding:5px 0;', 'color: #ffffff; background: rgba(49, 49, 49, 0.85); padding:5px 0;', 'color: rgb(0, 145, 228); background: rgba(49, 49, 49, 0.85); padding:5px 0;');

let deliveryRecord = [
    [
        'V1.0 Ê≠£ÂºèÁâà',
        '1.Êñ∞Â¢ûÈù¢ÊùøËÆæÁΩÆÂìçÂ∫îÂºè',
        '2.‰º™PjaxÂåñ',
        '3.‰ºòÂåñÂìçÂ∫îÂºèÂâçÁ´ØJavaScriptÊû∂ÊûÑ'
    ],
    [
        'V0.3',
        '1.‰øÆÂ§çÊèí‰ª∂È°µÂä®ÁîªBUG',
        '2.Êñ∞Â¢û BTCO POP',
        '3.ÂéªÈô§Âõ†ÂØºÂÖ•ÊÆã‰ΩôÂ∫ìÂØºËá¥ÁöÑÊä•Èîô'
    ],
    [
        'V0.2',
        '1.Êõ¥Êñ∞Êèí‰ª∂È°µÊ†∑Âºè',
        '2.Èù¢ÊùøÁâàÊú¨ÈôêÂà∂'
    ],
    [
        'V0.1',
        '1.ÂàùÂßãÂåñÈ°πÁõÆ',
        '2.ÂàùÂßãÊûÑÈÄ†Êèí‰ª∂È°µ (ÂÆùÂ°îÁ¨¨‰∏âÊñπÊèí‰ª∂È¶ñ‰∏™‰∏ç‰ΩøÁî®ÂÆòÊñπÊèí‰ª∂Ê®°Êùø)',
        '3.Â¢ûÂä†È¶ñÈ°µÂìçÂ∫îÂºè'
    ]
]

const BTCO = {
    init: (DOMID, callback) => {    // ÂàùÂßãÂåñ
        //> layui ÂºπÁ™óÁªÑ‰ª∂Ë∞ÉÁî®
        _.LE('msg', ['Ê≠£Âú®Â§ÑÁêÜ BTCO...', 0])

        //> DOM ÊèíÂÖ•Ê£ÄÊµã
        if (document.getElementById(DOMID) == null) {

            if (_.isMobile()) document.body.innerHTML = '' // Êö¥ÂäõËß£ÂÜ≥ÁßªÂä®Á´ØÈÄÇÈÖçÊªöÂä®Êù°ÈóÆÈ¢ò

            //> ÊèíÂÖ•DOM
            let btcoMain = document.createElement('div')
            btcoMain.setAttribute('id', 'BTCO')
            btcoMain.setAttribute('dom-hash', Math.random().toString(36).slice(-8)) // ÂÜôÂÖ•‰º™ hash
            btcoMain.innerHTML = _btcoTEMP

            if (_.isMobile())
                document.body.appendChild(btcoMain)
            else
                document.body.insertBefore(btcoMain, document.body.firstChild)  // ÊèíÂÖ•ÊâÄÊúâÂÖÉÁ¥†ÊúÄ‰∏äÊñπ

            //> ÊèíÂÖ•meta
            let meta = document.createElement('meta')
            meta.content = 'width=device-width,initial-scale=1.0'
            meta.name = 'viewport'
            document.getElementsByTagName('head')[0].appendChild(meta)

            // callback
            callback(true)

        } else callback(false)
    },
    loadMask: (callback, show = true, text = '') => {    // Loading ÂÖÉÁ¥†
        if (show) {
            // Â±ïÁ§∫
            _.$('#BTCO_loadMaskDOM').style.display = 'block'
            _.$('#BTCO_loadMask').innerHTML = text
            setTimeout(() => {
                _.$('#BTCO_loadMaskDOM').style.opacity = 1
                setTimeout(() => callback(), 500)
            }, 1)
        } else {
            // ÈöêËóè
            _.$('#BTCO_loadMaskDOM').style.opacity = 0
            setTimeout(() => {
                _.$('#BTCO_loadMaskDOM').style.display = 'none'
                _.$('#BTCO_loadMask').innerHTML = ''
                callback()
            }, 500)
        }
    },
    newUSE: () => {     // Á¨¨‰∏ÄÊ¨°‰ΩøÁî®
        _.$('#BTCO_An').style.display = 'unset'
        setTimeout(() => {
            _.$('#BTCO_textAn').childNodes.forEach(v => {
                if (Global.textAnDOM === undefined || Global.textAnDOM === null) {
                    v.style.display = 'block'
                    setTimeout(() => v.style.opacity = 1, 1)
                    Global.textAnDOM = v
                } else Global.stack.push(() => {
                    setTimeout(() => {
                        Global.textAnDOM.style.opacity = 0
                        setTimeout(() => {
                            Global.textAnDOM.style.display = 'none'
                            v.style.display = 'block'
                            setTimeout(() => v.style.opacity = 1, 1)
                            Global.textAnDOM = v
                            setTimeout(() => _.next(), 500)
                        }, 500)
                    }, 1000)
                })
            })
            _.next()
        }, 1)
    },
    startInstall: () => {   // ÂêØÁî® BTCO È°µÈù¢
        _.$('#BTCO_textAn').style.opacity = 0
        setTimeout(() => {
            _.$('#BTCO_textAn').style.display = 'none'
            _.$('#BTCO_An').style.display = 'none'

            _.$('#BTCO_Precautions').style.display = 'flex'
            setTimeout(() => _.$('#BTCO_Precautions').style.opacity = 1, 1)

            // MAIN
            _.$('#BTCO-Install').onclick = () => {
                _.$('#BTCO_Precautions').style.opacity = 0
                setTimeout(() => {
                    _.$('#BTCO_Precautions').style.display = 'none'
                    BTCO.APP.installBTCO()
                }, 500)
            }

        }, 500)
    },
    successInstall: () => {     // Êìç‰ΩúÂêØÁî® BTCO ÊàêÂäü
        BTCO.loadMask(() => {
            _.$('#BTCO_Success').style.display = 'unset'
            setTimeout(() => _.$('#BTCO_Success').style.opacity = 1, 1)
            //setTimeout(() => window.location.reload(), 2000)
        }, false)
    },
    failureInstall: (text = 'ÂêØÁî®Â§±Ë¥•') => {
        BTCO.loadMask(() => {
            _.TIP(text, 1500, '#e91e63')
            _.$('#BTCO-Install').innerHTML = 'ÈáçÊñ∞Â∞ùËØïÂêØÁî®'
            _.$('#BTCO-warnInstall').innerHTML = 'ÂêØÁî® BTCO Êó∂Â§±Ë¥•‰∫ÜÔºÅËØ∑Ë∞®ÊÖéÈáçËØï'
            BTCO.startInstall()
        }, false)
    },
    unInstall: (text = '') => {
        BTCO.loadMask(() => {

            _.$('#BTCO_Hello').style.display = 'block'
            setTimeout(() => _.$('#BTCO_Hello').style.opacity = 1, 1)
            if (text == '')
                _.TIP('Â∑≤ÂÖ≥Èó≠ BTCO', 1500, '#3fc775')
            else _.TIP(text, 1500, '#e91e63')

            setTimeout(() => window.location.reload(), 2000)

        }, false)
    },
    Hello: () => {

        _.$('#BTCO_Hello').style.display = 'block'
        setTimeout(() => _.$('#BTCO_Hello').style.opacity = 1, 1)

        _.$('#BTCO-unInstall').onclick = () => {
            _.$('#BTCO_Hello').style.opacity = 0
            setTimeout(() => {
                _.$('#BTCO_Hello').style.display = 'none'
                BTCO.loadMask(() => {

                    if (!_.isDev())
                        $.post("/plugin?action=a&s=BtcoRemove&name=btco", {}, (rdata) => {
                            if (rdata.status)   // ÂÖ≥Èó≠ÊàêÂäü
                                setTimeout(() => BTCO.unInstall(), 1000)
                            else BTCO.unInstall(rdata.msg)  // ÂÖ≥Èó≠Â§±Ë¥•
                        })
                    else setTimeout(() => BTCO.unInstall(), 1000) // DevÊ®°Âºè Á≠âÂæÖ‰∏ÄÁßíÁõ¥Êé•ÊàêÂäü

                }, true, 'Ê≠£Âú®ÂÖ≥Èó≠ BTCO')
            }, 500)
        }

    },

    APP: {
        installBTCO: () => {    // ÂêØÁî® BTCO
            BTCO.loadMask(() => {
                if (!_.isDev())
                    $.post('/plugin?action=a&s=BtcoInstall&name=btco', {}, (rdata) => {
                        if (rdata.status)   // ÂêØÁî®ÊàêÂäü
                            BTCO.successInstall()
                        else BTCO.failureInstall(rdata.msg)  // ÂêØÁî®Â§±Ë¥•
                    })
                else setTimeout(() => BTCO.successInstall(), 1000) // DevÊ®°Âºè Á≠âÂæÖ‰∏ÄÁßíÁõ¥Êé•ÊàêÂäü | BTCO.failureInstall()
            }, true, 'Ê≠£Âú®ÂêØÁî® BTCO Âà∞ÊÇ®ÁöÑÈù¢Êùø')
        }
    }
}, _ = {
    TIP: (text, end = 1000, color = '#fff') => {    // ÂºπÂá∫ TIP
        _.$('#BTCO_TIP').style.display = 'block'
        _.$('#BTCO_textTIP').innerHTML = text
        if (color != '#fff') _.$('#BTCO_textTIP').style.color = color
        setTimeout(() => _.$('#BTCO_TIP').style.opacity = 1, 1)
        setTimeout(() => {
            _.$('#BTCO_TIP').style.opacity = 0
            setTimeout(() => {
                _.$('#BTCO_TIP').style.display = 'none'
                _.$('#BTCO_textTIP').innerHTML = ''
            }, 500)
        }, end)
    },
    LE: (type, arr = []) => {   // layui ÂºπÁ™óÁªÑ‰ª∂ÂÆö‰πâ
        if (process.env.NODE_ENV !== 'development' && !_.isMobile())
            if (type === 'msg') {
                parent.layer.closeAll()
                layer.msg(arr[0], {
                    time: arr[1]
                })
            } else if (type === 'close')
                parent.layer.closeAll()
            else console.log('[BTCO] layer Á±ªÂûãÂºÇÂ∏∏')
        else console.log('[BTCO] Ëß¶Âèë layer ‰∫ã‰ª∂ > ' + type)
    },
    $: (strExpr) => {   // ‰º™ JQuery ÂÖÉÁ¥†ÈÄâÊã©
        let idExpr = /^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]*))$/,
            classExpr = /^(?:\s*(<[\w\W]+>)[^>]*|.([\w-]*))$/
        if (idExpr.test(strExpr))
            return document.getElementById(idExpr.exec(strExpr)[2])
        else if (classExpr.test(strExpr)) {
            let classMatch = classExpr.exec(strExpr),
                allElement = document.getElementsByTagName("*"),
                ClassMatch = []
            for (var i = 0, l = allElement.length; i < l; i++) {
                if (allElement[i].className.match(new RegExp("(\\s|^)" + classMatch[2] + "(\\s|$)")))
                    ClassMatch.push(allElement[i]);
            }
            return ClassMatch
        }
    },
    next: () => {   // ÈòüÂàóÊâßË°å
        let fn = Global.stack[Global.index]
        Global.index = Global.index + 1
        if (typeof fn === 'function') {
            if (Global.index == Global.stack.length)
                setTimeout(() => BTCO.startInstall(), 2500)
            fn()
        }
    },
    background: () => {     // ÂΩ©Â∏¶ËÉåÊôØÁîüÊàê
        _.$('#BTCO_evanyou').width = Global.backgroup.w * Global.backgroup.pr
        _.$('#BTCO_evanyou').height = Global.backgroup.h * Global.backgroup.pr
        let evanyouDom = _.$('#BTCO_evanyou').getContext('2d')
        evanyouDom.scale(Global.backgroup.pr, Global.backgroup.pr)
        evanyouDom.globalAlpha = 0.6

        evanyouDom.clearRect(0, 0, Global.backgroup.w, Global.backgroup.h)
        Global.backgroup.q = [{
            x: 0,
            y: Global.backgroup.h * .7 + Global.backgroup.f
        }, {
            x: 0,
            y: Global.backgroup.h * .7 - Global.backgroup.f
        }]
        while (Global.backgroup.q[1].x < Global.backgroup.w + Global.backgroup.f)
            d(Global.backgroup.q[0], Global.backgroup.q[1])

        function d(i, j) {
            evanyouDom.beginPath()
            evanyouDom.moveTo(i.x, i.y)
            evanyouDom.lineTo(j.x, j.y)
            var k = j.x + (Global.backgroup.z() * 2 - 0.25) * Global.backgroup.f,
                n = Global.backgroup.y(j.y)
            evanyouDom.lineTo(k, n)
            evanyouDom.closePath()
            Global.backgroup.r -= Global.backgroup.u / -50
            evanyouDom.fillStyle = '#' +
                (
                    Global.backgroup.v(Global.backgroup.r) * 127 + 128 << 16 |
                    Global.backgroup.v(Global.backgroup.r + Global.backgroup.u / 3) * 127 + 128 << 8 |
                    Global.backgroup.v(Global.backgroup.r + Global.backgroup.u / 3 * 2) * 127 + 128
                ).toString(16)
            evanyouDom.fill()
            Global.backgroup.q[0] = Global.backgroup.q[1]
            Global.backgroup.q[1] = {
                x: k,
                y: n
            }
        }
    },
    isDev: () => {      // Dev Ê®°Âºè
        if (process.env.NODE_ENV === 'development')
            return true
        else return false
    },
    isMobile: () => {
        if (/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i.test(window.navigator.userAgent))
            return true
        else return false
    }
}, Global = {   // ÂÖ®Â±ÄÂèòÈáè
    index: 0,
    stack: [],
    textAnDOM: undefined,
    backgroup: {
        pr: window.devicePixelRatio || 1,
        w: window.innerWidth,
        h: window.innerHeight,
        f: 90,
        q: '',
        r: 0,
        u: Math.PI * 2,
        v: Math.cos,
        z: Math.random,
        y: (p) => {
            let t = p + (Global.backgroup.z() * 2 - 1.1) * Global.backgroup.f
            return (t > Global.backgroup.h || t < 0) ? Global.backgroup.y(p) : t
        }
    }
}

//> ËΩΩÂÖ• BTCO
BTCO.init('BTCO', check => {
    if (!check)
        _.LE('msg', ['Êó†ÈúÄÈáçÂ§çÊâìÂºÄ', 1500])   //> layui ÂºπÁ™óÁªÑ‰ª∂Ë∞ÉÁî®
    else {
        _.LE('close')     //> layui ÂºπÁ™óÁªÑ‰ª∂ÂÖ≥Èó≠Ë∞ÉÁî®

        //> ‰∫åÊ¨°Ê£ÄÊµã Ôºü ÂèØÂéªÂæÖÂÆö
        if (document.getElementById('BTCO') !== null)
            _.background()  // ËΩΩÂÖ•ËÉåÊôØ

        //> ÂÆûÊó∂Âπ¥‰ªΩ
        _.$('#BTCO-crData').innerHTML = '&copy 2019 - ' + new Date().getFullYear()

        //> ËΩΩÂÖ• BTCO ‰ª£ÈÄÅËÆ∞ÂΩï
        deliveryRecord.forEach(v => {
            let pDom = ''
            v.forEach(i => {
                pDom += '<p>' + i + '</p>'
            })
            _.$('#BTCO-deliveryRecord').innerHTML += '<div>' + pDom + '</div>'
        })

        if (_.isMobile()) {
            _.$('#BTCO').style.width = '100vw'
            _.$('#BTCO').style.left = 0
        }

        setTimeout(() => {
            _.$('#BTCO').style.opacity = 1  // Â±ïÁ§∫ BTCO ‰∏ªË¶ÅÂÆπÂô®

            setTimeout(() => {
                // Main

                if (!_.isDev())
                    $.post('/plugin?action=a&s=BtcoInstallCheck&name=btco', {}, (rdata) => {
                        BTCO.loadMask(() => {
                            if (!rdata.status)  // Êú™ÂÆâË£Ö
                                BTCO.newUSE()
                            else BTCO.Hello()   // Â∑≤ÂÆâË£Ö
                        }, false)
                    })
                else
                    BTCO.loadMask(() => {
                        //BTCO.Hello()
                        BTCO.newUSE()
                    }, false)
                //> Ê≠§Â§ÑÂèØ‰∏∫ Èô§ init Â§ñÁöÑ‰ªªÊÑè‰∫ã‰ª∂

            }, 500)
        }, 100)

    }
})

// Dev
if (_.isDev()) {
    // Á¶ÅÁî®‰æßËæπËæπË∑ù
    _.$('#BTCO').style.width = '100vw'
} else if (!_.isMobile()) _.$('#memuAsoft').firstChild.nextElementSibling.innerHTML = 'BTCO'   // Êõ¥ÂèòÂÆùÂ°îÈù¢Êùø‰æßÊ†èÊñáÊú¨